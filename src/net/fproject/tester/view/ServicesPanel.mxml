<?xml version="1.0" encoding="utf-8"?>
<!--

Licensed to the Apache Software Foundation (ASF) under one or more
contributor license agreements.  See the NOTICE file distributed with
this work for additional information regarding copyright ownership.
The ASF licenses this file to You under the Apache License, Version 2.0
(the "License"); you may not use this file except in compliance with
the License.  You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

-->
<s:Panel xmlns:fx="http://ns.adobe.com/mxml/2009" 
		 xmlns:s="library://ns.adobe.com/flex/spark" 
		 xmlns:mx="library://ns.adobe.com/flex/mx" 
		 creationComplete="init()" title="Methods and services">
	<s:DataGrid height="180" width="250" left="10" top="10" 
				id="serviceList"
				gridClick="onServiceClick(event)"
				gridItemEditorSessionSave="onEditEnd(event)"
				dataProvider="{serviceInfo.activeProfile.services}" 
				editable="true">
		<s:columns>
			<s:ArrayList>
				<s:GridColumn headerText="Services" dataField="name"/>
			</s:ArrayList>
		</s:columns>
	</s:DataGrid>
	<s:DataGrid height="180" left="268" top="10" right="10"
				id="methodList"
				gridClick="onMethodClick(event)"
				gridItemEditorSessionSave="onEditEnd(event)"
				dataProvider="{activeService.methods}" 
				editable="true">
		<s:columns>
			<s:ArrayList>
				<s:GridColumn headerText="Methods" dataField="name"/>
			</s:ArrayList>
		</s:columns>
	</s:DataGrid>
	<s:DataGrid top="10" id="argumentsGrid" dataProvider="{activeMethod.arguments}" right="10" width="386" height="180" editable="true">
		<s:columns>
			<s:ArrayList>
				<s:GridColumn headerText="Arguments" dataField="name"/>
				<s:GridColumn headerText="Default values" dataField="value"/>
				<s:GridColumn headerText="Type" dataField="type">
					<s:itemEditor>
						<fx:Component>
							<s:ComboBoxGridItemEditor dataProvider="{RemoteArgument.allTypes}">
								<fx:Script>
									<![CDATA[
										import net.fproject.tester.model.RemoteArgument;
									]]>
								</fx:Script>
							</s:ComboBoxGridItemEditor>
						</fx:Component>
					</s:itemEditor>
				</s:GridColumn>
			</s:ArrayList>
		</s:columns>
	</s:DataGrid>
	
	<s:Button icon="@Embed(source='assets/add.png')" toolTip="Add service"
			  id="addServiceBtn" left="10" top="201" width="50"
			  click="onAddServiceClick(event)"/>
	<s:Button icon="@Embed(source='assets/delete.png')" toolTip="Delete service"
			  id="deleteServiceBtn" left="65" top="201" width="50"
			  enabled="{serviceList.selectedIndex>=0}" click="onDeleteServiceClick(event)"/>
	<s:Button x="120" y="201" icon="@Embed(source='assets/cog_add.png')" 
			  id="discoverBtn" width="50" toolTip="Discover AMF endpoint"
			  click="discoverClick(event)"/>
	
	<s:Button icon="@Embed(source='assets/add.png')" toolTip="Add method"
			  id="addMethodBtn" left="268" top="200" width="50"
			  enabled="{activeService!=null}" click="onMethodAdd(event)"/>
	<s:Button icon="@Embed(source='assets/delete.png')" toolTip="Delete method"
			  id="deleteMethodBtn" left="323" top="200" width="50"
			  enabled="{methodList.selectedIndex>=0}" click="onMethodDelete(event)"/>
	
	<s:Button icon="@Embed(source='assets/add.png')" toolTip="Add method argument"
			  id="addArgBtn" right="346" top="201" width="50"
			  enabled="{activeMethod!=null}" click="onArgumentAdd(event)"/>
	<s:Button icon="@Embed(source='assets/delete.png')" toolTip="Delete method argument"
			  id="deleteArgBtn" right="291" top="201" width="50"
			  enabled="{argumentsGrid.selectedIndex>=0}" click="onArgumentDelete(event)"/>
	
	<fx:Script>
		<![CDATA[
			import mx.core.FlexGlobals;
			import spark.events.GridItemEditorEvent;
			import spark.events.GridEvent;
			import mx.core.IFlexDisplayObject;
			import mx.events.FlexEvent;
			import mx.events.ListEvent;
			import mx.managers.PopUpManager;
			
			import net.fproject.tester.controller.EventHub;
			import net.fproject.tester.events.ProfileModifiedEvent;
			import net.fproject.tester.events.StatusChangeEvent;
			import net.fproject.tester.model.RemoteArgument;
			import net.fproject.tester.model.RemoteMethod;
			import net.fproject.tester.model.RemoteService;
			import net.fproject.tester.model.ServiceInfo;
			
			[Bindable]
			private var serviceInfo:ServiceInfo = ServiceInfo.getInstance();
			private var eventHub:EventHub = EventHub.getInstance();
			
			[Bindable]
			public var activeService:RemoteService;
			[Bindable]
			public var activeMethod:RemoteMethod;
			
			private var discoverPopup:IFlexDisplayObject;
			
			private function init():void
			{
				eventHub.addEventListener( StatusChangeEvent.RESET, onReset );
				eventHub.addEventListener( StatusChangeEvent.CONNECTING, onConnecting );
			}
			
			private function onConnecting( event:StatusChangeEvent ):void
			{
				this.activeService = null;
				this.activeMethod = null;
			}
			
			private function onReset( event:StatusChangeEvent ):void
			{
				activeMethod = null;
				activeService = null;
			}
			
			private function discoverClick( event:MouseEvent ):void
			{
				if(discoverPopup == null)
					discoverPopup = new DiscoverWindow;
				PopUpManager.addPopUp(discoverPopup,FlexGlobals.topLevelApplication as DisplayObject, true );
				PopUpManager.centerPopUp(discoverPopup);
			}
			
			private function onAddServiceClick( event:MouseEvent ):void
			{
				var s:RemoteService = new RemoteService();
				serviceInfo.activeProfile.services.addItem( s );
				eventHub.dispatchEvent( new ProfileModifiedEvent( ProfileModifiedEvent.CHANGED ) );	
			}
			
			private function onDeleteServiceClick( event:MouseEvent ):void
			{
				if( serviceList.selectedIndex < 0 )
				{
					return;	
				}	
				
				var s:RemoteService = RemoteService( serviceInfo.activeProfile.services.getItemAt( serviceList.selectedIndex ) );
				serviceInfo.activeProfile.services.removeItemAt( serviceList.selectedIndex );
				if( activeService == s )
				{
					activeService = null;
				}
			}
			
			private function onEditEnd( event:Event ):void
			{
				serviceList.callLater(serviceInfo.dataChanged);
			}
			
			private function onServiceClick(event:Event ):void
			{
				activeService = RemoteService( serviceList.selectedItem );
			}
			
			private function onMethodAdd( event:MouseEvent ):void
			{
				var m:RemoteMethod = new RemoteMethod();
				activeService.methods.addItem( m );
			}
			
			private function onMethodDelete( event:MouseEvent ):void
			{
				if( methodList.selectedIndex < 0 )
					return;
				
				var m:RemoteMethod = RemoteMethod( activeService.methods.getItemAt( methodList.selectedIndex ) );
				activeService.methods.removeItemAt( methodList.selectedIndex );
				if( activeMethod == m )
				{
					activeMethod = null;
				}
			}
			
			private function onMethodClick( event:Event ):void
			{
				activeMethod = RemoteMethod(methodList.selectedItem );
			}
			
			private function onArgumentClick( event:ListEvent):void
			{
				
			}
			
			private function onArgumentAdd( event:MouseEvent ):void
			{
				activeMethod.arguments.addItem( new RemoteArgument() );
			}
			
			private function onArgumentDelete( event:MouseEvent ):void
			{
				if( argumentsGrid.selectedIndex < 0 )
					return;
				activeMethod.arguments.removeItemAt( argumentsGrid.selectedIndex );
			}
			
		]]>
	</fx:Script>		
</s:Panel>
